    <!-- Map Section -->
    
    <?php

    // commentsubmit.php -- Receive comments and e-mail them to someone
    // Copyright (C) 2011 Matt Palmer <mpalmer@hezmatt.org>
    //
    //  This program is free software; you can redistribute it and/or modify it
    //  under the terms of the GNU General Public License version 3, as
    //  published by the Free Software Foundation.
    //
    //  This program is distributed in the hope that it will be useful, but
    //  WITHOUT ANY WARRANTY; without even the implied warranty of
    //  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
    //  General Public License for more details.
    //
    //  You should have received a copy of the GNU General Public License along
    //  with this program; if not, see <http://www.gnu.org/licences/>


    // Format of the date you want to use in your comments.  See
    // http://php.net/manual/en/function.date.php for the insane details of this
    // format.
    $DATE_FORMAT = "Y-m-d H:i";

    // Where the comment e-mails should be sent to.  This will also be used as
    // the From: address.  Whilst you could, in theory, change this to take the
    // address out of the form, it's *incredibly* highly recommended you don't,
    // because that turns you into an open relay, and that's not cool.
    $EMAIL_ADDRESS = "chackras@gmail.com";

    // The subject of all blog comment e-mails.  If you're running lots of these,
    // you might want to customise it, or if you were running a generic comment
    // handler you could take it out of the form, but really, who cares what your
    // comment e-mails are titled, as long as you can recognise it?
    $SUBJECT = "Blog Comment Received";

    // The contents of the following file (relative to this PHP file) will be
    // displayed after the comment is received.  Customise it to your heart's
    // content.
    $COMMENT_RECEIVED = "comment_received.html";

    /****************************************************************************
     * HERE BE CODE
     ****************************************************************************/

    $post_id = $_POST["post_id"];
    unset($_POST["post_id"]);
    $msg = "post_id: $post_id\n";
    $msg .= "date: " . date($DATE_FORMAT) . "\n";

    foreach ($_POST as $key => $value) {
    	if (strstr($value, "\n") != "") {
    		// Value has newlines... need to indent them so the YAML
    		// looks right
    		$value = str_replace("\n", "\n  ", $value);
    	}
    	// It's easier just to single-quote everything than to try and work
    	// out what might need quoting
    	$value = "'" . str_replace("'", "''", $value) . "'";
    	$msg .= "$key: $value\n";
    }

    if (mail($EMAIL_ADDRESS, $SUBJECT, $msg, "From: $EMAIL_ADDRESS"))
    {
    	include $COMMENT_RECEIVED;
    }
    else
    {
    	echo "There was a problem sending the comment. Please contact the site's owner.";
    }
    <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
       "http://www.w3.org/TR/html4/strict.dtd">
    <html>
    	<head>
    		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
    		<?php if (isset($_POST['return_url']))
    		{
    			$return_url = $_POST['return_url'];
    			$return_delay = 5; //Number of seconds to linger on this page before redirecting back to the static site
    			echo "<meta http-equiv=\"refresh\" content=\"$return_delay;url='$return_url'\" />";
    		} ?>
    		<title>Comment Received</title>
    	</head>
    <body>
    <h1>Comment Received</h1>
    	<p>Thank you for your comment. It will be reviewed and published shortly.</p>
    	<?php if (isset($return_url))
    	{
    		echo '<p>You are now returning to the page you were on. Click the link if you are not redirected automatically.</p>';
    		echo '<p><a href="'.$return_url.'">'.$return_url.'</a></p>';
    	} ?>
    </body>
    </html>
    <div id="comments">
    	{% case page.comment_count %}
    		{% when 0 %}
    		{% when 1 %}
    			<h1>1 Comment</h1>
    		{% else %}
    			<h1>{{page.comment_count}} Comments</h1>
    	{% endcase %}
    	{% for c in page.comments %}
    		<div class="comment {% cycle 'odd', 'even' %}">
    			<p class="comment_header">
    				From: {% if c.link and c.link != '' %}
    					<a href="{{c.link}}">{{c.name}}</a>
    				{% else %}
    					{{c.name}}
    				{% endif %}
    				<br />
    				<span class="comment_date">{{c.date}}</span>
    			</p>
    			<p>
    				{{c.comment | newline_to_br}}
    			</p>
    		</div>
    	{% endfor %}
    	<h1>Post a comment</h1>
    	<p style="font-style: italic">
    		All comments are held for moderation; basic HTML formatting accepted.
    	</p>
    	<form id="commentform" method="POST" action="{{site.url}}/commentsubmit.php">
    		<input type="hidden" name="post_id" value="{{page.id}}" />
    		<input type="hidden" name="return_url" value="{{site.url}}{{page.url}}" />
    		<table>
    			<tr>
    				<th>Name:</th>
    				<td><input type="text" size="25" name="name" /> (required)</td>
    			</tr>
    			<tr>
    				<th>E-mail:</th>
    				<td><input type="text" size="25" name="email" /> (required, not published)</td>
    			</tr>
    			<tr>
    				<th>Website:</th>
    				<td><input type="text" size="25" name="link" /> (optional)</td>
    			</tr>
    			<tr>
    				<td colspan="2"><textarea name="comment" rows="10" cols="60" ></textarea></td>
    			</tr>
    			<tr>
    				<td><input type="submit" name="submit" value="Submit Comment" /></td>
    			</tr>
    		</table>
    	</form>
    </div>
